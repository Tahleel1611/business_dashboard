{% extends 'base.html' %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<!-- Dashboard Header -->
<h1>Business Dashboard</h1>

<!-- Search Form -->
<form method="get" action="{% url 'dashboard' %}" class="search-form">
    <input type="text" name="query" placeholder="Search products..." value="{{ request.GET.query }}">
    <button type="submit" class="icon-search">Search</button>
</form>

<!-- Stats Section -->
<div class="stats-row">
    <div class="stat-card success">
        <div class="stat-card-header">
            <span class="icon-chart"></span>
            Total Sales
        </div>
        <div class="stat-card-value">{{ total_sales }}</div>
        <div class="stat-card-description">The total number of products sold.</div>
    </div>
    
    <div class="stat-card info">
        <div class="stat-card-header">
            <span class="icon-money"></span>
            Total Revenue
        </div>
        <div class="stat-card-value">â‚¹{{ total_revenue|floatformat:2 }}</div>
        <div class="stat-card-description">Total revenue generated, including GST.</div>
    </div>
    
    <div class="stat-card warning">
        <div class="stat-card-header">
            <span class="icon-cart"></span>
            Total Purchases
        </div>
        <div class="stat-card-value">â‚¹{{ total_purchases|floatformat:2 }}</div>
        <div class="stat-card-description">Total amount spent on purchases.</div>
    </div>
</div>

<!-- Products Table -->
<div class="table-container">
    <div class="table-header">
        <h2><span class="icon-box"></span> Products Inventory</h2>
    </div>
    <table>
        <thead>
            <tr>
                <th>Product</th>
                <th>Category</th>
                <th>Stock</th>
                <th>Price (â‚¹)</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for product in products %}
            <tr>
                <td><strong>{{ product.name }}</strong></td>
                <td>{{ product.category.name }}</td>
                <td>
                    <span class="{% if product.stock_quantity < 10 %}stock-low{% elif product.stock_quantity < 20 %}stock-medium{% else %}stock-good{% endif %}">
                        {{ product.stock_quantity }} units
                    </span>
                </td>
                <td>â‚¹{{ product.price|floatformat:2 }}</td>
                <td>
                    <a href="{% url 'generate_invoice' product.id %}" class="btn btn-outline btn-sm icon-pdf">
                        Invoice
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Low Stock Alerts -->
<div class="alert-section">
    <h3><span class="icon-alert"></span> Low Stock Products</h3>
    {% if low_stock_products %}
    <ul class="alert-list">
        {% for product in low_stock_products %}
        <li>
            <span><strong>{{ product.name }}</strong></span>
            <span class="badge">{{ product.stock_quantity }} left</span>
        </li>
        {% endfor %}
    </ul>
    {% else %}
    <p class="success-message">âœ“ All products are sufficiently stocked!</p>
    {% endif %}
</div>

<!-- Sales Graph -->
<div class="chart-container">
    <h3>ðŸ“ˆ Sales Over Time</h3>
    <canvas id="salesChart" width="400" height="150"></canvas>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Sales Graph Data
    var salesDates = JSON.parse('{{ dates|escapejs }}');
    var salesQuantities = JSON.parse('{{ quantities|escapejs }}');

    if (typeof Chart !== 'undefined') {
        var ctx = document.getElementById('salesChart').getContext('2d');
        var salesChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: salesDates,
                datasets: [{
                    label: 'Sales Quantity',
                    data: salesQuantities,
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    fill: true,
                    tension: 0.4,
                    borderWidth: 3,
                    pointBackgroundColor: '#3498db',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                    }
                },
                scales: {
                    x: { 
                        title: { display: true, text: 'Date' },
                        grid: { display: false }
                    },
                    y: { 
                        title: { display: true, text: 'Quantity Sold' }, 
                        beginAtZero: true,
                        grid: { color: 'rgba(0,0,0,0.05)' }
                    }
                }
            }
        });
    }
</script>
{% endblock %}
